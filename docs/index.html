import React, { useState, useEffect, useRef, useMemo } from 'react';

// --- CONFIGURAÇÕES VISUAIS BARROCAS ---
const THEME = {
  gold: '#D4AF37',
  goldLight: '#F1D592',
  burgundy: '#600000',
  darkWood: '#1a0f00',
  parchment: '#f4e4bc',
  shadow: 'rgba(0,0,0,0.5)'
};

const FREQS = { 'do_lat': 261.63, 're_lat': 293.66, 'mi_lat': 329.63, 'fa_lat': 349.23, 'sol_lat': 392.00, 'la_lat': 440.00, 'si_lat': 493.88 };
const LABELS = { 'do_lat': 'Dó', 're_lat': 'Ré', 'mi_lat': 'Mi', 'fa_lat': 'Fá', 'sol_lat': 'Sol', 'la_lat': 'Lá', 'si_lat': 'Si' };
const FINGERINGS = {
  'do_lat': [true, true, true, true, true, true, true, true],
  're_lat': [true, true, true, true, true, true, true, false],
  'mi_lat': [true, true, true, true, true, true, false, false],
  'fa_lat': [true, true, true, true, true, false, true, true],
  'sol_lat': [true, true, true, true, false, false, false, false],
  'la_lat': [true, true, true, false, false, false, false, false],
  'si_lat': [true, true, false, false, false, false, false, false]
};

// --- BIBLIOTECA DE MÚSICAS (Original Reintegrada) ---
const songLibrary = {
  nivelDo: [
    { title: "O Despertar", abc: "C2 C2 C4" },
    { title: "Sopro Constante", abc: "C C C2 C C C2" }
  ],
  nivelRe: [
    { title: "Dueto em Ré", abc: "C D C D C2 D2" },
    { title: "Salto Real", abc: "D2 C2 D4" }
  ],
  nivelMi: [
    { title: "Hino à Alegria (Tema)", abc: "E E F G G F E D C C D E E3 D/ D2" },
    { title: "Valsa Imperial", abc: "E2 D2 C2 E4" }
  ],
  nivelFa: [
    { title: "Brisa do Sena", abc: "F E D C F2 E2" }
  ],
  nivelSol: [
    { title: "Asa Branca (Intro)", abc: "C D E G G E F F" }
  ],
  nivelLa: [
    { title: "Melodia de Versalhes", abc: "A G F E D C A2" }
  ],
  nivelSi: [
    { title: "Escala Real", abc: "C D E F G A B C2" }
  ]
};

// --- ICONES ORNAMENTADOS ---
const OrnateIcon = ({ name, size = 24, className = "" }) => {
  const icons = {
    Lock: <path d="M7 11V7a5 5 0 0 1 10 0v4M8 11h8a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2z" />,
    Play: <path d="m5 3 14 9-14 9V3z" />,
    Check: <path d="M20 6 9 17l-5-5" />,
    Music: <><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></>,
    Scroll: <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>,
    Trophy: <><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></>
  };
  return (
    <svg viewBox="0 0 24 24" width={size} height={size} stroke="currentColor" strokeWidth="1.5" fill="none" strokeLinecap="round" strokeLinejoin="round" className={className}>
      {icons[name]}
    </svg>
  );
};

export default function App() {
  const [userProgress, setUserProgress] = useState(0);
  const [view, setView] = useState('map');
  const [activeItem, setActiveItem] = useState(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [activeNoteIdx, setActiveNoteIdx] = useState(-1);
  const [audioReady, setAudioReady] = useState(false);
  const [hasListened, setHasListened] = useState(false);
  
  const audioCtx = useRef(null);
  const scrollRef = useRef(null);

  // --- TRADUTOR ABC (Original) ---
  const parseABC = (abcString) => {
    const notesMap = {
      'C': 'do_lat', 'D': 're_lat', 'E': 'mi_lat', 'F': 'fa_lat', 
      'G': 'sol_lat', 'A': 'la_lat', 'B': 'si_lat'
    };
    const regex = /([CDEFGAB])([\d/]*)/g;
    const sequence = [];
    let match;
    while ((match = regex.exec(abcString)) !== null) {
      let noteLetter = match[1];
      let modifier = match[2];
      let duration = 1;
      if (modifier.includes('2')) duration = 2;
      else if (modifier.includes('3')) duration = 3;
      else if (modifier.includes('4')) duration = 4;
      else if (modifier.includes('/')) duration = 0.5;
      if (notesMap[noteLetter]) sequence.push({ n: notesMap[noteLetter], d: duration });
    }
    return sequence;
  };

  // --- GERADOR DE CURRÍCULO COM MÚSICAS REAIS ---
  const fullCurriculum = useMemo(() => {
    const levelConfigs = [
      { id: 'nivelDo', name: "Dó", notes: ["do_lat"], dur: [1, 2] },
      { id: 'nivelRe', name: "Ré", notes: ["do_lat", "re_lat"], dur: [1, 2] },
      { id: 'nivelMi', name: "Mi", notes: ["do_lat", "re_lat", "mi_lat"], dur: [1, 2] },
      { id: 'nivelFa', name: "Fá", notes: ["do_lat", "re_lat", "mi_lat", "fa_lat"], dur: [1, 0.5] },
      { id: 'nivelSol', name: "Sol", notes: ["do_lat", "re_lat", "mi_lat", "fa_lat", "sol_lat"], dur: [1, 0.5] },
      { id: 'nivelLa', name: "Lá", notes: ["do_lat", "re_lat", "mi_lat", "fa_lat", "sol_lat", "la_lat"], dur: [1, 2] },
      { id: 'nivelSi', name: "Si", notes: ["do_lat", "re_lat", "mi_lat", "fa_lat", "sol_lat", "la_lat", "si_lat"], dur: [1, 0.5, 2] }
    ];

    const trail = [];
    levelConfigs.forEach((lvl) => {
      // 1. Adiciona as 18 lições de treino
      for (let i = 1; i <= 18; i++) {
        const sequence = [];
        const len = 4 + (i % 3);
        for (let j = 0; j < len; j++) {
          sequence.push({
            n: lvl.notes[Math.floor(Math.random() * lvl.notes.length)],
            d: lvl.dur[Math.floor(Math.random() * lvl.dur.length)]
          });
        }
        trail.push({
          type: 'lesson',
          levelName: lvl.name,
          title: `Treino ${i}: ${lvl.name}`,
          sequence
        });
      }
      
      // 2. Adiciona as músicas REAIS da biblioteca para este nível
      const songs = songLibrary[lvl.id] || [];
      songs.forEach(song => {
        trail.push({
          type: 'song',
          levelName: lvl.name,
          title: `Recital: ${song.title}`,
          sequence: parseABC(song.abc)
        });
      });
    });
    return trail;
  }, []);

  const initAudio = () => {
    if (!audioCtx.current) {
      audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
      setAudioReady(true);
    }
  };

  const playNote = (note, duration, startTime) => {
    if (!note || !FREQS[note]) return;
    const osc = audioCtx.current.createOscillator();
    const gain = audioCtx.current.createGain();
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(FREQS[note], startTime);
    gain.gain.setValueAtTime(0, startTime);
    gain.gain.linearRampToValueAtTime(0.12, startTime + 0.08);
    gain.gain.setValueAtTime(0.12, startTime + duration - 0.1);
    gain.gain.linearRampToValueAtTime(0, startTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.current.destination);
    osc.start(startTime);
    osc.stop(startTime + duration);
  };

  const handleStartPlayback = () => {
    if (!audioReady) initAudio();
    if (isPlaying || !activeItem) return;
    setIsPlaying(true);
    setHasListened(false);
    let scheduleTime = audioCtx.current.currentTime + 0.3;
    activeItem.sequence.forEach((item, idx) => {
      const dur = item.d * 0.8;
      playNote(item.n, dur, scheduleTime);
      setTimeout(() => setActiveNoteIdx(idx), (scheduleTime - audioCtx.current.currentTime) * 1000);
      scheduleTime += dur;
    });
    setTimeout(() => {
      setIsPlaying(false);
      setActiveNoteIdx(-1);
      setHasListened(true);
    }, (scheduleTime - audioCtx.current.currentTime) * 1000);
  };

  const handleComplete = () => {
    const currentIndex = fullCurriculum.indexOf(activeItem);
    if (userProgress === currentIndex) setUserProgress(prev => prev + 1);
    setHasListened(false);
    setView('map');
  };

  // --- VIEW: MAPA ---
  if (view === 'map') return (
    <div className="min-h-screen bg-[#1a0f00] text-[#f4e4bc] p-6 md:p-12 overflow-x-hidden font-serif">
      <header className="text-center mb-16">
        <h1 className="text-5xl md:text-7xl font-black text-[#D4AF37] uppercase tracking-tighter mb-2" style={{ fontFamily: 'Cinzel, serif' }}>
          Academia Imperial
        </h1>
        <div className="h-1 w-64 bg-gradient-to-r from-transparent via-[#D4AF37] to-transparent mx-auto opacity-40"></div>
        <p className="mt-4 text-[#B8860B] uppercase tracking-[0.4em] text-xs">A Arte de Soprar com Nobreza</p>
      </header>

      <div className="flex flex-wrap justify-center gap-6 max-w-7xl mx-auto pb-32">
        {fullCurriculum.map((item, idx) => {
          const isUnlocked = idx <= userProgress;
          const isCompleted = idx < userProgress;
          const isNext = idx === userProgress;
          return (
            <div key={idx} onClick={() => isUnlocked && (setActiveItem(item), setView('player'))}
              className={`relative w-40 h-52 md:w-48 md:h-60 group flex flex-col items-center justify-center border-2 transition-all duration-500 rounded-sm
                ${isUnlocked ? 'cursor-pointer hover:scale-105 active:scale-95' : 'cursor-not-allowed opacity-30 grayscale'}
                ${isNext ? 'border-[#D4AF37] bg-[#2a1b0a] shadow-[0_0_30px_rgba(212,175,55,0.3)]' : 'border-[#3a2b1a] bg-[#1a0f00]'}
              `}>
              <div className="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 border-[#D4AF37]/40"></div>
              <div className="p-4 rounded-full mb-3 border border-[#D4AF37]/20">
                <OrnateIcon name={!isUnlocked ? 'Lock' : (item.type === 'lesson' ? 'Scroll' : 'Music')} size={32} className={isNext ? 'text-[#D4AF37] animate-pulse' : 'text-[#B8860B]'} />
              </div>
              <div className="px-2 text-center">
                <h4 className="text-[10px] font-bold text-[#D4AF37] uppercase tracking-widest">{item.title}</h4>
                <p className="text-[9px] text-[#800000] mt-1 italic">{item.levelName}</p>
              </div>
              {isCompleted && <div className="absolute -top-3 -right-3 bg-[#D4AF37] text-black rounded-full p-1 shadow-lg"><OrnateIcon name="Check" size={14} /></div>}
            </div>
          );
        })}
      </div>

      <footer className="fixed bottom-0 left-0 right-0 p-5 bg-black/90 backdrop-blur-md border-t border-[#D4AF37]/30 flex justify-between items-center z-50">
         <div className="px-4">
           <p className="text-[9px] uppercase text-[#B8860B] tracking-widest">Maestria Alcançada</p>
           <p className="text-sm font-bold text-[#D4AF37]">{userProgress} Estações</p>
         </div>
         <div className="h-2 flex-1 mx-8 bg-[#3a2b1a] rounded-full overflow-hidden border border-white/5">
            <div className="h-full bg-gradient-to-r from-[#800000] to-[#D4AF37] transition-all duration-1000" style={{ width: `${(userProgress / fullCurriculum.length) * 100}%` }}></div>
         </div>
      </footer>
    </div>
  );

  // --- VIEW: PLAYER ---
  return (
    <div className="min-h-screen bg-[#1a0f00] text-[#f4e4bc] p-4 md:p-10 font-serif flex flex-col" style={{ backgroundImage: 'radial-gradient(circle at center, #2a1b0a 0%, #1a0f00 100%)' }}>
      <div className="max-w-5xl mx-auto w-full flex-1 flex flex-col">
        <button onClick={() => setView('map')} className="w-fit text-[#D4AF37] mb-8 flex items-center gap-2 uppercase tracking-[0.3em] text-xs font-bold hover:brightness-125 transition-all">
          ← Sair do Estúdio
        </button>

        <div className="bg-[#2a1b0a] border-4 border-double border-[#D4AF37] rounded-lg shadow-2xl p-6 md:p-12 relative overflow-hidden flex-1 flex flex-col">
          <div className="text-center mb-10">
            <span className="text-[#B8860B] text-[10px] uppercase tracking-[0.5em] block mb-2">{activeItem.levelName}</span>
            <h2 className="text-3xl md:text-5xl font-black text-white uppercase" style={{ fontFamily: 'Cinzel, serif' }}>{activeItem.title}</h2>
          </div>

          <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
            <div className="flex-1 w-full space-y-8">
              <div className="bg-[#1a0f00]/80 p-6 rounded border border-[#D4AF37]/20 flex flex-wrap justify-center gap-2 overflow-y-auto max-h-64 no-scrollbar">
                {activeItem.sequence.map((step, i) => (
                  <div key={i} className={`w-14 h-20 border-2 flex flex-col items-center justify-center transition-all duration-300
                      ${activeNoteIdx === i ? 'bg-[#D4AF37] border-white scale-110 text-black' : 'bg-[#2a1b0a] border-[#D4AF37]/40 text-[#D4AF37]'}
                    `} style={{ minWidth: step.d >= 2 ? '100px' : '60px' }}>
                    <span className="text-xl font-black">{LABELS[step.n]?.toUpperCase()}</span>
                    <span className="text-[9px] opacity-60 uppercase">{step.d}t</span>
                  </div>
                ))}
              </div>

              <div className="flex flex-col gap-4 max-w-sm mx-auto">
                <button onClick={handleStartPlayback} disabled={isPlaying}
                  className={`w-full py-5 font-bold text-lg uppercase tracking-widest transition-all border-b-4
                    ${isPlaying ? 'bg-gray-800 border-gray-900 text-gray-600' : 'bg-[#D4AF37] text-black border-[#800000] hover:brightness-110 active:translate-y-1 active:border-b-0'}
                  `}>
                  {isPlaying ? 'Escute a Corte...' : 'Ouvir Guia'}
                </button>
                {hasListened && !isPlaying && (
                  <button onClick={handleComplete} className="w-full py-5 bg-[#800000] text-[#D4AF37] border-2 border-[#D4AF37] font-bold text-lg uppercase tracking-widest hover:bg-[#a00000]">
                    Concluir Atividade
                  </button>
                )}
              </div>
            </div>

            <div className="bg-[#1a0f00] p-10 rounded-full border-2 border-[#D4AF37]/30 shadow-2xl">
                <svg viewBox="0 0 100 240" className="w-[120px] md:w-[150px] h-auto">
                  <rect x="35" y="0" width="30" height="240" rx="15" fill="#3a1a00" stroke="#D4AF37" strokeWidth="1" />
                  <circle className={`transition-all duration-200 ${activeNoteIdx >= 0 && FINGERINGS[activeItem.sequence[activeNoteIdx].n][0] ? 'fill-[#D4AF37]' : 'fill-[#1a0f00]'}`} cx="85" cy="40" r="10" stroke="#D4AF37" strokeWidth="0.5" />
                  {[1,2,3,4,5,6,7].map(h => (
                    <circle key={h} className={`transition-all duration-200 ${activeNoteIdx >= 0 && FINGERINGS[activeItem.sequence[activeNoteIdx].n][h] ? 'fill-[#D4AF37]' : 'fill-[#1a0f00]'}`} cx="50" cy={30 + (h * 26)} r="10" stroke="#D4AF37" strokeWidth="0.5" />
                  ))}
                </svg>
            </div>
          </div>
        </div>
      </div>
      
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');
        body { background-color: #1a0f00; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
      `}</style>
    </div>
  );
}

