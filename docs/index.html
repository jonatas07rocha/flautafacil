<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Academia Real de Flauta - Edição Imperial</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="songs.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #D4AF37;
            --gold-light: #F1D592;
            --burgundy: #600000;
            --dark-wood: #1a0f00;
            --parchment: #f4e4bc;
        }

        body {
            margin: 0;
            background-color: var(--dark-wood);
            color: var(--parchment);
            font-family: 'Playfair Display', serif;
            overflow-x: hidden;
            background-image: radial-gradient(circle at center, #2a1b0a 0%, #1a0f00 100%);
        }

        .baroque-title { font-family: 'Cinzel', serif; text-shadow: 0 4px 10px rgba(0,0,0,0.8); }

        .baroque-box {
            position: relative;
            background: #2a1b0a;
            border: 4px border-double var(--gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .box-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gold);
            pointer-events: none;
        }
        .corner-tl { top: -5px; left: -5px; border-right: 0; border-bottom: 0; }
        .corner-tr { top: -5px; right: -5px; border-left: 0; border-bottom: 0; }
        .corner-bl { bottom: -5px; left: -5px; border-right: 0; border-top: 0; }
        .corner-br { bottom: -5px; right: -5px; border-left: 0; border-top: 0; }

        .next-challenge { animation: pulse-gold 2s infinite; border-color: var(--gold-light) !important; }
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 5px var(--gold); }
            50% { box-shadow: 0 0 25px var(--gold); }
        }

        .flute-hole { transition: fill 0.2s ease; stroke: var(--gold); stroke-width: 0.5; fill: #1a0f00; }
        .flute-hole.active { fill: var(--gold); filter: drop-shadow(0 0 8px var(--gold)); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const FREQS = { 
            'do_lat': 261.63, 're_lat': 293.66, 'mi_lat': 329.63, 'fa_lat': 349.23, 'sol_lat': 392.00, 'la_lat': 440.00, 'si_lat': 493.88,
            'do2_lat': 523.25, 're2_lat': 587.33
        };
        const LABELS = { 
            'do_lat': 'Dó', 're_lat': 'Ré', 'mi_lat': 'Mi', 'fa_lat': 'Fá', 'sol_lat': 'Sol', 'la_lat': 'Lá', 'si_lat': 'Si',
            'do2_lat': 'Dó♯', 're2_lat': 'Ré♯' 
        };
        const FINGERINGS = {
            'si_lat':  [true, true, false, false, false, false, false, false],
            'la_lat':  [true, true, true, false, false, false, false, false],
            'sol_lat': [true, true, true, true, false, false, false, false],
            'do2_lat': [true, false, true, false, false, false, false, false],
            're2_lat': [false, false, true, false, false, false, false, false],
            'fa_lat':  [true, true, true, true, true, false, true, true],
            'mi_lat':  [true, true, true, true, true, true, false, false],
            're_lat':  [true, true, true, true, true, true, true, false],
            'do_lat':  [true, true, true, true, true, true, true, true]
        };

        const OrnateIcon = ({ name, size = 24, className = "" }) => {
            const icons = {
                Lock: <path d="M7 11V7a5 5 0 0 1 10 0v4M8 11h8a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2z" />,
                Play: <path d="m5 3 14 9-14 9V3z" />,
                Check: <path d="M20 6 9 17l-5-5" />,
                Music: <><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></>,
                Scroll: <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            };
            return <svg viewBox="0 0 24 24" width={size} height={size} stroke="currentColor" strokeWidth="1.5" fill="none" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        const App = () => {
            const [view, setView] = useState('map');
            const [userProgress, setUserProgress] = useState(() => {
                return parseInt(localStorage.getItem('userProgress')) || 0;
            });
            const [activeItem, setActiveItem] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [activeNoteIdx, setActiveNoteIdx] = useState(-1);
            const [hasListened, setHasListened] = useState(false);
            const audioCtx = useRef(null);
            const lastSequenceRef = useRef("");

            const parseABC = (abc) => {
                const map = { 'B': 'si_lat', 'A': 'la_lat', 'G': 'sol_lat', 'c': 'do2_lat', 'd': 're2_lat', 'F': 'fa_lat', 'E': 'mi_lat', 'D': 're_lat', 'C': 'do_lat' };
                const regex = /([ABCDEFGcdefg])([>]*)([\d/]*)/g;
                const seq = [];
                let m;
                while ((m = regex.exec(abc)) !== null) {
                    let dur = 1;
                    if (m[3].includes('2')) dur = 2; else if (m[3].includes('4')) dur = 4; else if (m[3].includes('/')) dur = 0.5;
                    if (m[2] === ">") dur = 1.5;
                    if (map[m[1]]) seq.push({ n: map[m[1]], d: dur });
                }
                return seq;
            };

            const fullCurriculum = useMemo(() => {
                if (!window.songLibrary) return [];
                const keys = ['nivelSi', 'nivelLa', 'nivelSol', 'nivelDo', 'nivelRe', 'nivelFa', 'nivelMi'];
                const labels = {
                    nivelSi: 'Si', nivelLa: 'Lá', nivelSol: 'Sol',
                    nivelDo: 'Dó+', nivelRe: 'Ré+', nivelFa: 'Fá', nivelMi: 'Mi'
                };
                
                const trail = [];
                keys.forEach(key => {
                    const songs = window.songLibrary[key];
                    if (!songs || songs.length === 0) return;

                    const levelNotes = [...new Set(songs.flatMap(s => parseABC(s.abc).map(n => n.n)))];
                    
                    // Geração de 2 Exercícios dinâmicos por nível
                    for (let i = 1; i <= 2; i++) {
                        let sequence;
                        let seqString;
                        do {
                            sequence = Array(4).fill(0).map(() => ({
                                n: levelNotes[Math.floor(Math.random() * levelNotes.length)],
                                d: Math.random() > 0.8 ? 2 : 1
                            }));
                            seqString = JSON.stringify(sequence);
                        } while (seqString === lastSequenceRef.current);
                        lastSequenceRef.current = seqString;

                        trail.push({
                            type: 'lesson',
                            title: `Exercício ${i}`,
                            level: labels[key],
                            sequence: sequence
                        });
                    }

                    // Músicas reais do songs.js
                    songs.forEach(song => {
                        trail.push({
                            type: 'song',
                            title: song.title,
                            level: labels[key],
                            sequence: parseABC(song.abc)
                        });
                    });
                });
                return trail;
            }, []);

            useEffect(() => {
                localStorage.setItem('userProgress', userProgress);
            }, [userProgress]);

            const playNote = (note, duration, start) => {
                if (!audioCtx.current) audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.current.createOscillator();
                const gain = audioCtx.current.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(FREQS[note], start);
                gain.gain.setValueAtTime(0, start);
                gain.gain.linearRampToValueAtTime(0.1, start + 0.05);
                gain.gain.setValueAtTime(0.1, start + duration - 0.05);
                gain.gain.linearRampToValueAtTime(0, start + duration);
                osc.connect(gain); gain.connect(audioCtx.current.destination);
                osc.start(start); osc.stop(start + duration);
            };

            const startPlayback = () => {
                if (isPlaying || !activeItem) return;
                setIsPlaying(true);
                if (!audioCtx.current) audioCtx.current = new AudioContext();
                let time = audioCtx.current.currentTime + 0.1;
                activeItem.sequence.forEach((item, idx) => {
                    const d = item.d * 0.6;
                    playNote(item.n, d, time);
                    setTimeout(() => setActiveNoteIdx(idx), (time - audioCtx.current.currentTime) * 1000);
                    time += d;
                });
                setTimeout(() => { 
                    setIsPlaying(false); 
                    setActiveNoteIdx(-1); 
                    setHasListened(true); 
                }, (time - audioCtx.current.currentTime) * 1000);
            };

            const handleSelectItem = (item) => {
                setActiveItem(item);
                setHasListened(false);
                setActiveNoteIdx(-1);
                setView('player');
            };

            if (view === 'map') return (
                <div className="min-h-screen p-8 flex flex-col items-center">
                    <header className="text-center mb-16">
                        <h1 className="baroque-title text-5xl md:text-7xl text-[#D4AF37] mb-2 uppercase tracking-tighter">Academia Real</h1>
                        <p className="text-[#B8860B] uppercase tracking-[0.4em] text-[10px] font-bold">Consumindo Biblioteca Real</p>
                    </header>
                    <div className="flex flex-wrap justify-center gap-8 max-w-7xl pb-40">
                        {fullCurriculum.map((item, idx) => {
                            const isLocked = idx > userProgress;
                            const isNext = idx === userProgress;
                            return (
                                <div key={idx} onClick={() => !isLocked && handleSelectItem(item)}
                                    className={`baroque-box w-44 h-60 flex flex-col items-center justify-center p-6 transition-all ${isLocked ? 'opacity-30 grayscale cursor-not-allowed' : 'cursor-pointer hover:scale-105'} ${isNext ? 'next-challenge' : 'border-[#3a2b1a]'}`}>
                                    <div className="box-corner corner-tl"></div><div className="box-corner corner-tr"></div>
                                    <div className="box-corner corner-bl"></div><div className="box-corner corner-br"></div>
                                    <div className={`p-4 rounded-full mb-4 border ${isNext ? 'bg-[#D4AF37]/10 border-[#D4AF37]' : 'border-[#D4AF37]/20'}`}>
                                        <OrnateIcon name={isLocked ? 'Lock' : (item.type === 'lesson' ? 'Scroll' : 'Music')} size={32} className="text-[#D4AF37]" />
                                    </div>
                                    <h4 className="text-[10px] font-black text-[#D4AF37] uppercase tracking-widest text-center">{item.title}</h4>
                                    <p className="text-[8px] text-[#800000] mt-2 italic">{item.level}</p>
                                    {idx < userProgress && <div className="absolute -top-2 -right-2 bg-[#D4AF37] text-black rounded-full p-1 shadow-lg"><OrnateIcon name="Check" size={14} /></div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-10 flex flex-col items-center">
                    <button onClick={() => setView('map')} className="self-start text-[#D4AF37] uppercase text-[10px] font-bold tracking-[0.3em] mb-10">← Voltar</button>
                    <div className="w-full max-w-5xl bg-[#2a1b0a] border-4 border-double border-[#D4AF37]/40 rounded-lg shadow-2xl p-8 md:p-12 flex flex-col lg:flex-row items-center gap-12">
                        <div className="flex-1 w-full space-y-8">
                            <div className="text-center lg:text-left">
                                <span className="text-[#B8860B] text-[10px] uppercase tracking-[0.5em]">{activeItem.level}</span>
                                <h2 className="baroque-title text-3xl md:text-5xl text-white uppercase">{activeItem.title}</h2>
                            </div>
                            <div className="bg-black/40 p-6 rounded border border-[#D4AF37]/10 flex flex-wrap justify-center lg:justify-start gap-2 max-h-60 overflow-y-auto no-scrollbar">
                                {activeItem.sequence.map((s, i) => (
                                    <div key={i} className={`w-12 h-18 border flex flex-col items-center justify-center transition-all ${activeNoteIdx === i ? 'bg-[#D4AF37] text-black scale-110 shadow-lg' : 'bg-[#1a0f00] border-[#D4AF37]/20 text-[#D4AF37]'}`} style={{ minWidth: s.d >= 2 ? '80px' : '48px' }}>
                                        <span className="text-lg font-black">{LABELS[s.n]?.toUpperCase()}</span>
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-4">
                                <button onClick={startPlayback} disabled={isPlaying} className="flex-1 py-5 bg-[#D4AF37] text-black font-bold uppercase tracking-widest hover:brightness-110 disabled:opacity-50">Ouvir Guia</button>
                                {!isPlaying && <button onClick={() => { if(userProgress === fullCurriculum.indexOf(activeItem)) setUserProgress(p => p + 1); setView('map'); }} disabled={!hasListened} className="flex-1 py-5 bg-[#600000] text-[#D4AF37] border border-[#D4AF37] font-bold uppercase tracking-widest hover:bg-[#800000] disabled:opacity-30">Concluir</button>}
                            </div>
                        </div>
                        <div className="bg-[#1a0f00] p-10 rounded-full border-2 border-[#D4AF37]/20 shadow-2xl">
                            <svg viewBox="0 0 100 240" className="w-[120px] md:w-[150px] h-auto">
                                <rect x="38" y="0" width="24" height="240" rx="12" fill="#3a1a00" stroke="#D4AF37" strokeWidth="0.5" />
                                <circle className={`flute-hole ${activeNoteIdx >= 0 && FINGERINGS[activeItem.sequence[activeNoteIdx].n][0] ? 'active' : ''}`} cx="85" cy="40" r="10" />
                                {[1,2,3,4,5,6,7].map(h => <circle key={h} className={`flute-hole ${activeNoteIdx >= 0 && FINGERINGS[activeItem.sequence[activeNoteIdx].n][h] ? 'active' : ''}`} cx="50" cy={30 + (h * 26)} r="10" />)}
                            </svg>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

