<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mestre da Flauta - 120 Exercícios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #F8FAFC; overflow: hidden; margin: 0; }
        .progress-bar-fill { transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .note-block { transition: all 0.2s; border-width: 3px; }
        .note-block.active { transform: scaleY(1.1); border-color: #10B981; background-color: #064E3B; box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .flute-hole { fill: #334155; stroke: #475569; stroke-width: 1.5; transition: fill 0.1s; }
        .flute-hole.closed { fill: #3B82F6; stroke: #DBEAFE; }
        button:active { transform: scale(0.96); }
        .no-select { user-select: none; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- MAPAS TÉCNICOS ---
        const FREQS = { 'do_lat': 261.63, 're_lat': 293.66, 'mi_lat': 329.63, 'fa_lat': 349.23, 'sol_lat': 392.00, 'la_lat': 440.00, 'si_lat': 493.88 };
        const LABELS = { 'do_lat': 'DÓ', 're_lat': 'RÉ', 'mi_lat': 'MI', 'fa_lat': 'FÁ', 'sol_lat': 'SOL', 'la_lat': 'LÁ', 'si_lat': 'SI' };
        const FINGERINGS = {
            'do_lat': [true, true, true, true, true, true, true, true],
            're_lat': [true, true, true, true, true, true, true, false],
            'mi_lat': [true, true, true, true, true, true, false, false],
            'fa_lat': [true, true, true, true, true, false, true, true],
            'sol_lat': [true, true, true, true, false, false, false, false],
            'la_lat': [true, true, true, false, false, false, false, false],
            'si_lat': [true, true, false, false, false, false, false, false]
        };

        const App = () => {
            const [view, setView] = useState('menu'); // 'menu' | 'player'
            const [levelIdx, setLevelIdx] = useState(0);
            const [exerciseIdx, setExerciseIdx] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [activeNoteIdx, setActiveNoteIdx] = useState(-1);
            const [audioReady, setAudioReady] = useState(false);

            const audioCtx = useRef(null);

            // --- MOTOR DE DADOS (Expansão para 120 Exercícios) ---
            const curriculum = useMemo(() => {
                const baseLevels = [
                    { id: 1, name: "Nível Dó", notes: ["do_lat"], dur: ["q", "h"], goal: "Estabilidade do sopro" },
                    { id: 2, name: "Nível Ré", notes: ["do_lat", "re_lat"], dur: ["q", "h"], goal: "Alternância inicial" },
                    { id: 3, name: "Nível Mi", notes: ["do_lat", "re_lat", "mi_lat"], dur: ["q", "h"], goal: "Três primeiras notas" },
                    { id: 4, name: "Nível Fá", notes: ["do_lat", "re_lat", "mi_lat", "fa_lat"], dur: ["q", "8"], goal: "Introdução de colcheias" },
                    { id: 5, name: "Nível Sol", notes: ["do_lat", "re_lat", "mi_lat", "fa_lat", "sol_lat"], dur: ["q", "8"], goal: "Escala de 5 notas" },
                    { id: 6, name: "Nível Lá", notes: ["do_lat", "re_lat", "mi_lat", "fa_lat", "sol_lat", "la_lat"], dur: ["q", "h"], goal: "Expansão melódica" },
                    { id: 7, name: "Nível Si", notes: ["do_lat", "re_lat", "mi_lat", "fa_lat", "sol_lat", "la_lat", "si_lat"], dur: ["q", "h", "8"], goal: "Escala completa" }
                ];

                return baseLevels.map(lvl => {
                    const exList = [];
                    // Gerar 17-18 exercícios por nível para atingir ~120 total
                    for (let i = 1; i <= 18; i++) {
                        const sequence = [];
                        const len = 4 + (i % 4); // Variar comprimento entre 4 e 8 notas
                        for (let j = 0; j < len; j++) {
                            const isRest = j === len - 1 ? false : Math.random() < 0.1;
                            sequence.push({
                                n: isRest ? null : lvl.notes[Math.floor(Math.random() * lvl.notes.length)],
                                d: lvl.dur[Math.floor(Math.random() * lvl.dur.length)] === 'h' ? 2 : (lvl.dur[Math.floor(Math.random() * lvl.dur.length)] === '8' ? 0.5 : 1)
                            });
                        }
                        // Forçar repouso no final
                        sequence[sequence.length - 1].n = lvl.notes[0];
                        sequence[sequence.length - 1].d = 2;

                        exList.push({
                            id: `L${lvl.id}-E${i.toString().padStart(2, '0')}`,
                            objective: i % 2 === 0 ? "Repetição e Memória" : lvl.goal,
                            sequence: sequence,
                            repose: lvl.notes[0]
                        });
                    }
                    return { ...lvl, exercises: exList };
                });
            }, []);

            const currentLevel = curriculum[levelIdx];
            const currentExercise = currentLevel.exercises[exerciseIdx];

            // --- LÓGICA DE ÁUDIO ---
            const initAudio = () => {
                if (!audioCtx.current) {
                    audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                    setAudioReady(true);
                }
            };

            const playNote = (note, duration, startTime) => {
                if (!note || !FREQS[note]) return;
                const osc = audioCtx.current.createOscillator();
                const gain = audioCtx.current.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(FREQS[note], startTime);
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.1, startTime + 0.03);
                gain.gain.setValueAtTime(0.1, startTime + duration - 0.03);
                gain.gain.linearRampToValueAtTime(0, startTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.current.destination);
                osc.start(startTime);
                osc.stop(startTime + duration);
            };

            const startExercise = async () => {
                if (!audioReady) initAudio();
                if (isPlaying) return;

                setIsPlaying(true);
                const beat = 0.8; // 75 BPM aprox
                let now = audioCtx.current.currentTime + 0.1;

                currentExercise.sequence.forEach((item, idx) => {
                    const dur = item.d * beat;
                    if (item.n) playNote(item.n, dur, now);
                    
                    setTimeout(() => setActiveNoteIdx(idx), (now - audioCtx.current.currentTime) * 1000);
                    now += dur;
                });

                setTimeout(() => {
                    setIsPlaying(false);
                    setActiveNoteIdx(-1);
                }, (now - audioCtx.current.currentTime) * 1000);
            };

            // --- TELAS ---
            if (view === 'menu') {
                return (
                    <div className="p-6 h-full overflow-y-auto no-select">
                        <h1 className="text-3xl font-black text-emerald-500 mb-2">FLAUTA DOCE</h1>
                        <p className="text-slate-400 text-sm mb-8 font-semibold">TREINO DIÁRIO • {curriculum.length * 18} LIÇÕES</p>
                        
                        <div className="flex flex-col gap-4 pb-20">
                            {curriculum.map((lvl, i) => (
                                <div key={lvl.id} className="bg-slate-800 rounded-3xl p-5 border border-slate-700">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-extrabold text-xl">{lvl.name}</h3>
                                        <span className="text-xs bg-slate-900 px-3 py-1 rounded-full text-slate-400 font-bold uppercase tracking-wider">
                                            {lvl.exercises.length} Lições
                                        </span>
                                    </div>
                                    <p className="text-slate-400 text-sm mb-4">{lvl.goal}</p>
                                    <button 
                                        onClick={() => { setLevelIdx(i); setExerciseIdx(0); setView('player'); }}
                                        className="w-full bg-emerald-500 py-3 rounded-2xl text-emerald-950 font-black"
                                    >
                                        COMEÇAR
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen flex flex-col p-4 no-select bg-slate-950">
                    {/* Header Estilo Duolingo */}
                    <div className="flex items-center gap-4 mb-8">
                        <button onClick={() => setView('menu')} className="p-2 text-slate-500">
                            <i data-lucide="x"></i>
                        </button>
                        <div className="flex-1 h-3 bg-slate-800 rounded-full overflow-hidden">
                            <div 
                                className="h-full bg-emerald-500 progress-bar-fill"
                                style={{ width: `${((exerciseIdx + 1) / currentLevel.exercises.length) * 100}%` }}
                            ></div>
                        </div>
                    </div>

                    {/* Área Pedagógica */}
                    <div className="text-center mb-6">
                        <h2 className="text-2xl font-black mb-1">{currentExercise.objective}</h2>
                        <div className="flex justify-center gap-2">
                            {currentLevel.notes.map(n => (
                                <span key={n} className="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-500 font-bold">
                                    {LABELS[n]}
                                </span>
                            ))}
                        </div>
                    </div>

                    {/* Notação Abstrata (Blocos Rítmicos) */}
                    <div className="flex-1 flex flex-col justify-center items-center gap-12">
                        <div className="w-full flex justify-center items-center gap-1 h-24 overflow-x-auto px-4">
                            {currentExercise.sequence.map((step, i) => (
                                <div 
                                    key={i}
                                    className={`note-block rounded-xl flex items-center justify-center font-black text-sm
                                        ${step.n ? 'bg-slate-800 border-slate-700 text-slate-400' : 'bg-transparent border-dashed border-slate-800'}
                                        ${activeNoteIdx === i ? 'active text-emerald-400' : ''}
                                    `}
                                    style={{ 
                                        minWidth: `${step.d * 40}px`,
                                        height: step.n ? '50px' : '20px'
                                    }}
                                >
                                    {step.n && LABELS[step.n]}
                                </div>
                            ))}
                        </div>

                        {/* Digitação */}
                        <div className="bg-slate-900 p-8 rounded-[3rem] border border-slate-800 shadow-2xl">
                            <svg viewBox="0 0 100 240" width="80" height="200">
                                <rect x="35" y="0" width="30" height="240" rx="15" fill="#1E293B" />
                                {/* Polegar */}
                                <circle 
                                    className={`flute-hole ${activeNoteIdx >= 0 && currentExercise.sequence[activeNoteIdx].n && FINGERINGS[currentExercise.sequence[activeNoteIdx].n][0] ? 'closed' : ''}`}
                                    cx="85" cy="40" r="8" 
                                />
                                {/* Frontais */}
                                {[1,2,3,4,5,6,7].map(h => (
                                    <circle 
                                        key={h}
                                        className={`flute-hole ${activeNoteIdx >= 0 && currentExercise.sequence[activeNoteIdx].n && FINGERINGS[currentExercise.sequence[activeNoteIdx].n][h] ? 'closed' : ''}`}
                                        cx="50" cy={30 + (h * 26)} r="8" 
                                    />
                                ))}
                            </svg>
                        </div>
                    </div>

                    {/* Botões de Ação */}
                    <div className="mt-auto flex flex-col gap-3 py-6">
                        {!isPlaying && activeNoteIdx === -1 ? (
                            <button 
                                onClick={startExercise}
                                className="w-full bg-emerald-500 text-emerald-950 font-black py-5 rounded-2xl text-xl shadow-[0_5px_0_#059669] active:shadow-none active:translate-y-1 transition-all"
                            >
                                OUVIR E PRATICAR
                            </button>
                        ) : (
                            <div className="w-full py-5 text-center font-black text-emerald-500 animate-pulse tracking-widest">
                                OUÇA...
                            </div>
                        )}
                        
                        {!isPlaying && activeNoteIdx === -1 && (
                            <button 
                                onClick={() => {
                                    if (exerciseIdx < currentLevel.exercises.length - 1) {
                                        setExerciseIdx(prev => prev + 1);
                                    } else if (levelIdx < curriculum.length - 1) {
                                        setLevelIdx(prev => prev + 1);
                                        setExerciseIdx(0);
                                    } else {
                                        setView('menu');
                                    }
                                }}
                                className="w-full text-slate-500 font-bold py-3"
                            >
                                PRÓXIMO EXERCÍCIO
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => lucide.createIcons(), 150);
    </script>
</body>
</html>
